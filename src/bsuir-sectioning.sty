\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{bsuir-sectioning}[2024/05/28 Compact BSUIR Sectioning]

\RequirePackage[clearempty,newlinetospace]{titlesec}
\RequirePackage{titletoc}

\ExplSyntaxOn

\bool_new:N \g_bsuir_toc_bool \bool_set_true:N \g_bsuir_toc_bool

\NewDocumentCommand{\notoc}{m} { \bool_set_false:N \g_bsuir_toc_bool #1 \bool_set_true:N \g_bsuir_toc_bool }

\clist_map_inline:nn { {frontmatter}{-1}{false}, {mainmatter}{1}{true} } {
    \NewDocumentCommand{\clist_item:nn{#1}{1}}{} {
        \bool_gset:Nn \g_bsuir_toc_bool {\clist_item:nn{#1}{3}}
        \addtocontents{toc}{\protect\setcounter{tocdepth}{\clist_item:nn{#1}{2}}}
    }
}

\cs_new_eq:NN \old_toc \tableofcontents
\RenewDocumentCommand{\tableofcontents}{} { \old_toc \mainmatter }

\bool_new:N \g_app_started_bool
\NewDocumentCommand{\startappendices}{} {
    \bool_if:NT \g_app_started_bool { \prg_return_none: }
    \appendix \bool_gset_true:N \g_app_started_bool
    \renewcommand{\thechapter}{\Asbuk{chapter}}
    \titleformat{\chapter}[display]{\filcenter\bfseries\MakeUppercase}{ПРИЛОЖЕНИЕ~\thechapter}{0.5ex}{\MakeUppercase}
    \titlecontents{chapter}[100pt]{}{\hspace*{-100pt}Приложение~\thecontentslabel\hspace*{4pt}}{}{\titlerule*[4pt]{.}\thecontentspage}
    \addtocontents{toc}{\protect\setcounter{tocdepth}{0}}
}

\cs_new_eq:NN \old_bib \bibliography
\RenewDocumentCommand{\bibliography}{m} { \old_bib{#1} \startappendices }

\titleformat{\chapter}{\bfseries\MakeUppercase}{\thechapter}{\wordsep}{}
\titleformat{name=\chapter,numberless}{\centering\bfseries\MakeUppercase}{}{0pt}{}
\titlespacing{\chapter}{\parindent}{0pt}{\baselineskip}

\clist_map_inline:nn { section, subsection, subsubsection } {
    \exp_args:Nc \cs_new_eq:NN { old_#1 } { #1 }
    \exp_args:Nc \RenewDocumentCommand { #1 } { s m } {
        \IfBooleanTF {##1} { \use:c { old_#1 } * {##2} }
        { \use:c { old_#1 } {##2} \label{sec:\use:c { the#1 }} }
    }
    \titleformat{\use:c{#1}}[ \str_if_eq:nnTF{#1}{section}{hang}{runin} ]
        {\bfseries}{ \str_if_eq:nnTF{#1}{section}{\MakeUppercase}{} \use:c{the#1} }{\wordsep}{}
    \titlespacing{\use:c{#1}}{\parindent}{\baselineskip}{\wordsep}
}

\cs_new_eq:NN \old_chap \chapter
\RenewDocumentCommand{\chapter}{s o m}{
    \IfBooleanTF{#1} { \old_chap * {#3} \IfValueF{#2}{ \bool_if:NT \g_bsuir_toc_bool {\addcontentsline{toc}{chapter}{#3}} } }
    { \IfValueT{#2}{\startappendices} \old_chap [\IfValueTF{#2}{#2}{#3}] {#3} \label{sec:\thechapter} }
}

\NewDocumentCommand{\makeappendixpdf}{s o m s m s}{
    \IfBooleanTF{#4}{
        \chapter*[]{#3}
        \includepdf[pages=\IfBooleanTF{#1}{1}{1,pagecommand={}}]{#5}
        \IfBooleanT{#6}{ \includepdf[pages=2-\IfBooleanTF{#1}{,pagecommand={}}{}]{#5} }
    }{
        \begin{center}
            \IfValueTF{#2}{\chapter[#2]{#3}}{\chapter*[]{#3}\vfill}
            \includegraphics[width=\textwidth-8pt]{#5} \vfill
        \end{center}\clearpage
    }
}

\ExplSyntaxOff