\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{bsuir-math}[2025/12/28 Math Support]

\RequirePackage{expl3}
\RequirePackage{amsmath}
\RequirePackage{mathtools}

% Проверяем движок и загружаем unicode-math с обработкой ошибок
\RequirePackage{iftex}
\ifLuaTeX
  % Для LuaLaTeX пытаемся загрузить lualatex-math, но не критично если его нет
  \IfFileExists{lualatex-math.sty}{%
    \RequirePackage{lualatex-math}%
  }{%
    % Пакет не найден, продолжаем без него
    \PackageWarning{bsuir-math}{lualatex-math.sty not found, continuing without it}%
  }
\fi

\RequirePackage[math-style=TeX]{unicode-math}

% Шрифты (если есть STIX Two Math - он лучший для ГОСТ, иначе Cambria)
\IfFontExistsTF{STIX Two Math}{
  \setmathfont{STIX Two Math}
}{
  \IfFontExistsTF{Cambria Math}{
    \setmathfont{Cambria Math}
  }{
    \setmathfont{Latin Modern Math}
  }
}

% Checklist §4.2: Буквы латинского алфавита курсивом, русского и греческого прямым
% Это уже обрабатывается через unicode-math с math-style=TeX

% Нумерация формул в пределах раздела (Checklist §4.5)
\numberwithin{equation}{section}

% --- Формулы: размещение и отступы (Checklist §4.3) ---
% Используем KOMA-Script spacing infrastructure
% Базовые отступы для простых формул (приблизительно 24мм = ~68pt)
\setlength{\abovedisplayskip}{12pt plus 3pt minus 2pt}
\setlength{\belowdisplayskip}{12pt plus 3pt minus 2pt}
\setlength{\abovedisplayshortskip}{6pt plus 2pt minus 1pt}
\setlength{\belowdisplayshortskip}{6pt plus 2pt minus 1pt}

% Окружение для сложных формул (с Σ, Π, ∫ и т.п.) - приблизительно 32мм
\NewDocumentEnvironment{complexequation}{}{
  \begingroup
  \setlength{\abovedisplayskip}{16pt plus 4pt minus 3pt}
  \setlength{\belowdisplayskip}{16pt plus 4pt minus 3pt}
  \begin{equation}
}{
  \end{equation}
  \endgroup
}

% Окружение для формул с дробями в столбик - приблизительно 32мм
\NewDocumentEnvironment{fractionequation}{}{
  \begingroup
  \setlength{\abovedisplayskip}{16pt plus 4pt minus 3pt}
  \setlength{\belowdisplayskip}{16pt plus 4pt minus 3pt}
  \begin{equation}
}{
  \end{equation}
  \endgroup
}

% Окружение для формул с высокими знаками - приблизительно 48мм
\NewDocumentEnvironment{tallequation}{}{
  \begingroup
  \setlength{\abovedisplayskip}{24pt plus 6pt minus 4pt}
  \setlength{\belowdisplayskip}{24pt plus 6pt minus 4pt}
  \begin{equation}
}{
  \end{equation}
  \endgroup
}

% Checklist §4.4: Переносы формул
% При переносе знак операции пишут два раза
% При переносе на знаке умножения вместо «·» применяют знак «×»
% Это обрабатывается автоматически через amsmath

% Checklist §4.6: Номер формулы справа в круглых скобках
% Это стандартное поведение equation

% Checklist §4.8: Пояснения к формулам - окружение "где"
% Перечень начинают со слова «где», которое приводят с новой строки без абзацного отступа
% В этой же строке помещают первый поясняющий символ
% Символы необходимо отделять от расшифровок знаком тире, выравнивая перечень по символам
% Каждую расшифровку заканчивают точкой с запятой

% Используем простой список без enumitem для избежания предупреждений
\newenvironment{where}{%
  \par\noindent где\ 
  % Создаем простой список с фиксированными параметрами
  \list{}{%
    \setlength{\leftmargin}{0pt}%
    \setlength{\labelwidth}{2em}%
    \setlength{\labelsep}{0.5em}%
    \setlength{\itemindent}{0pt}%
    \setlength{\parsep}{0pt}%
    \setlength{\topsep}{0pt}%
    \setlength{\partopsep}{0pt}%
    \renewcommand{\makelabel}[1]{##1 ---}%
  }%
}{%
  \endlist
  \par
}

% Защита от конфликтов макросов: некоторые пакеты (в т.ч. языковые) пытаются
% \newcommand\sh/\tg/... в \AtBeginDocument. Если команды уже определены к этому
% моменту, LaTeX падает с "already defined". Решение: в hook'е
% begindocument/before временно делаем их "неопределёнными" для \newcommand
% (т.е. равными \relax), чтобы конфликтующий \newcommand прошёл.
\ExplSyntaxOn
\AddToHook{begindocument/before}
  {
    \cs_set_eq:NN \sh     \relax
    \cs_set_eq:NN \ch     \relax
    \cs_set_eq:NN \tg     \relax
    \cs_set_eq:NN \ctg    \relax
    \cs_set_eq:NN \arctg  \relax
    \cs_set_eq:NN \arcctg \relax
    \cs_set_eq:NN \cth    \relax
    \cs_set_eq:NN \cosec  \relax
  }
\ExplSyntaxOff

\endinput
