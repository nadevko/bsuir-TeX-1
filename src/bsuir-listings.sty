\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{bsuir-listings}[2025/12/28 Code Listings]

% --- Piton для подсветки ---
\RequirePackage{piton}
\PitonOptions{
  break-lines,
  indent-broken-lines,
  background-color = white, % STP обычно требует ч/б, но для кода можно
}

% --- Шрифты кода ---
% Checklist §10.2: Courier New, на 2 пункта меньше основного текста (12pt)
% Используем corefonts для Courier New
% Размер будет установлен через \fontsize в окружении
\setmonofont{Courier New}[
  Ligatures=TeX
]

% --- Окружение для листинга как рисунка ---
% Checklist §10: листинги считаются как рисунки, общий счётчик
\RequirePackage{caption}

% Настройка подписей для рисунков (листинги используют тот же counter)
% Формат: "Рисунок X -- Название", по центру
\captionsetup[figure]{
  format=plain,
  labelsep=endash,
  justification=centering,
  skip=\baselineskip
}

% Окружение для кода с подписью как рисунок
\NewDocumentEnvironment{codelisting}{O{} m}{
  \def\bsuir@codelisting@label{#1}%
  \def\bsuir@codelisting@caption{#2}%
  \begin{figure}[htbp]
  \centering
  \begingroup
  \fontsize{12pt}{14.4pt}\selectfont % 12pt font, 1.2 line spacing
  \ttfamily % Courier New моноширинный
  \PitonOptions{language=python} % Дефолт, можно менять
  \begin{Piton}
}{
  \end{Piton}
  \endgroup
  \caption{\bsuir@codelisting@caption}%
  \ifx\bsuir@codelisting@label\@empty\else\label{\bsuir@codelisting@label}\fi
  \end{figure}
}

% Враппер для обратной совместимости (старый синтаксис)
\NewDocumentEnvironment{code}{O{} m}{
  \begin{codelisting}[#1]{#2}
}{
  \end{codelisting}
}

% Загрузка кода из файла
\NewDocumentCommand{\inputcode}{O{} m m}{
  \begin{figure}[htbp]
  \centering
  \begingroup
  \fontsize{12pt}{14.4pt}\selectfont
  \ttfamily
  \PitonInputFile{#2}
  \endgroup
  \caption{#3}
  \label{#1}
  \end{figure}
}

\endinput
