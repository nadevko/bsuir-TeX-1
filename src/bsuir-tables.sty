\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{bsuir-tables}[2025/12/28 Tables]

\RequirePackage{expl3}
\RequirePackage{xparse}
\RequirePackage{tabularray}
\UseTblrLibrary{booktabs}
\UseTblrLibrary{counter}
\RequirePackage{caption}

\ExplSyntaxOn

% Checklist §6.1: До названия таблицы и после таблицы пустые строки
% Checklist §6.3: Заголовок и саму таблицу пробельной строкой не разделяют
\setlength{\intextsep}{\baselineskip} % Пробельная строка до и после таблицы
\captionsetup[table]{
  format=plain,
  labelsep=endash, % Тире между "Таблица X" и названием
  justification=raggedright, % По левому краю
  singlelinecheck=false,     % Даже если одна строка - влево
  skip=0pt, % Нет пробельной строки между названием и таблицей
  position=top
}

% Checklist §6.2: Название таблицы: "Таблица" номер тире название
% Слово "Таблица" начинают писать на уровне левой границы таблицы
% Это обрабатывается через justification=raggedright

% Глобальный стиль таблиц БГУИР
\DefTblrTemplate{contfoot-text}{default}{Продолжение таблицы \thetable}
\DefTblrTemplate{conthead-text}{default}{(Продолжение)}

% Внутренние переменные для хранения caption и label
\tl_new:N \l_bsuir_table_caption_tl
\tl_new:N \l_bsuir_table_label_tl
\tl_new:N \l_bsuir_table_inner_keys_tl
\tl_new:N \l_bsuir_table_tblr_keys_tl
\bool_new:N \l_bsuir_table_has_caption_bool
\bool_new:N \l_bsuir_table_has_label_bool

% Определение ключей для gosttable
\keys_define:nn { bsuir / gosttable }
  {
    caption .code:n = {
      \bool_set_true:N \l_bsuir_table_has_caption_bool
      \tl_set:Nn \l_bsuir_table_caption_tl { #1 }
    },
    label .code:n = {
      \bool_set_true:N \l_bsuir_table_has_label_bool
      \tl_set:Nn \l_bsuir_table_label_tl { #1 }
    },
    % Все остальные ключи передаются в tabularray
    unknown .code:n = {
      \tl_put_right:Nx \l_bsuir_table_inner_keys_tl
        { \exp_not:V \l_keys_key_str = \exp_not:n {#1} , }
    }
  }

% Окружение gosttable с парсингом ключей
\NewDocumentEnvironment { gosttable } { m }
  {
    % Инициализация
    \tl_clear:N \l_bsuir_table_caption_tl
    \tl_clear:N \l_bsuir_table_label_tl
    \tl_clear:N \l_bsuir_table_inner_keys_tl
    \bool_set_false:N \l_bsuir_table_has_caption_bool
    \bool_set_false:N \l_bsuir_table_has_label_bool
    
    % Парсинг ключей
    \keys_set:nn { bsuir / gosttable } { #1 }
    
    % Начало float окружения
    \begin{table}[htbp]
    \centering
    
    % Caption (если есть)
    \bool_if:NT \l_bsuir_table_has_caption_bool
      {
        \exp_args:NV \caption \l_bsuir_table_caption_tl
      }
    
    % Label (если есть)
    \bool_if:NT \l_bsuir_table_has_label_bool
      {
        \exp_args:NV \label \l_bsuir_table_label_tl
      }
    
    % Собираем ключи для tabularray заранее
    % Сначала добавляем пользовательские ключи (если есть)
    \tl_set:Nn \l_bsuir_table_tblr_keys_tl {}
    \tl_if_empty:NF \l_bsuir_table_inner_keys_tl
      { \tl_set_eq:NN \l_bsuir_table_tblr_keys_tl \l_bsuir_table_inner_keys_tl }
    
    % Добавляем стиль по умолчанию
    \tl_put_right:Nn \l_bsuir_table_tblr_keys_tl
      {
        hlines, vlines, % Сетка (обычно в инженерных дипломах сетка полная)
        rows={m},       % Вертикальное центрирование
        row{1}={font=\bfseries, c} % Заголовок жирный и по центру
      }

    % Начало tabularray окружения с собранными ключами
    % ВАЖНО: tabularray парсит colspec и не терпит нерасширяемые команды
    % (например, \tl_use:N) внутри значения colspec. Поэтому принудительно
    % разворачиваем tl-переменную через \expanded до передачи в tblr.
    % \expanded полностью разворачивает переменную перед передачей в tblr
    \expanded {
      \noexpand \begin { tblr } {
        \unexpanded \expandafter { \l_bsuir_table_tblr_keys_tl }
      }
    }
  }
  {
    \end{tblr}
    \end{table}
  }

\ExplSyntaxOff

\endinput
